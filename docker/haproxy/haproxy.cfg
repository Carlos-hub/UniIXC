global
daemon
log stdout local0
stats timeout 30s

defaults
mode tcp
log global
option tcplog
option dontlognull
retries 3
timeout connect 5000ms
timeout client 50000ms
timeout server 50000ms

# Stats interface
listen stats
bind *:8404
mode http
stats enable
stats uri /stats
stats refresh 30s
stats admin if TRUE

# PostgreSQL Primary (Write operations)
frontend pgsql_primary_frontend
bind *:5432
mode tcp
# Route based on user - postgres user goes to primary for writes
acl is_primary_user req.payload(0,0),hex,regsub(^.*,) -m str 706f737467726573
use_backend pgsql_primary_backend if is_primary_user
default_backend pgsql_slave_backend

# PostgreSQL Primary Backend
backend pgsql_primary_backend
mode tcp
balance roundrobin
option pgsql-check user postgres
server postgres_primary postgres_primary:5432 check

# PostgreSQL Slaves Backend (Read operations)
backend pgsql_slave_backend
mode tcp
balance roundrobin
option pgsql-check user postgres
server postgres_slave1 postgres_slave1:5432 check
server postgres_slave2 postgres_slave2:5432 check

# Alternative frontend for explicit primary access
frontend pgsql_write_frontend
bind *:5433
mode tcp
default_backend pgsql_primary_backend

# Alternative frontend for explicit slave access
frontend pgsql_read_frontend
bind *:5434
mode tcp
default_backend pgsql_slave_backend
